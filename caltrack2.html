<title>Calorie & Protein Tracker</title>
<link rel="icon" type="image/png" href="caltrack.png">
<style>
    html{
        padding-top: 1em;
        background: #333;
        color: #FFF;
    }
    table {
        border-collapse: collapse;
        max-height: 95vh; 
        overflow-y: auto; 
        display: block;
    }

    td, th {
        border: 1px solid #dddddd;
        padding: 0.5em;
    }

    tr:nth-child(even) {
        background-color: #444;
    }

    #tableContainer{
        display: flex;
        justify-content: space-evenly;
    }

    #userInput{
        display: flex;
        align-self: flex-start;
        height: 2em;
        padding-bottom: 1em;
    }
    #categories{
        height: 2em;
        width: 13em;
        margin-bottom: 1em;
    }

    .itemField{
        width: 12em;
    }
    .inputField{
        width: 5em;
    }
</style>

<div id="tableContainer">
    <table id="activeItems"></table>
    <div>
        <div id="userInput">
            <input class="itemField" id="item" placeholder="Item">
            <input class="inputField" id="calories" placeholder="Calories">
            <input class="inputField" id="protein" placeholder="Protein">
            <input class="inputField" id="quantity" placeholder="Quantity" value="1">
            <button onclick="saveItem()">ðŸ’¾</button>
            <button onclick="resetDay()">ðŸ”ƒ</button>
            <button onclick="insertActiveItem()">âž•</button>
        </div>

        <div>
            <select id="categories" onchange="renderSavedItems()"></select>
            <button onclick="removeCategory()">âž–</button>
            <button onclick="addCategory()">âž•</button>
        </div>
        

        <table id="savedItems"></table>
    </div>
</div>

<script>
    function init(){
        console.log('v1.1.0');

        let activeItems = JSON.parse(localStorage.getItem("activeItems"));
        let savedItems = JSON.parse(localStorage.getItem("savedItems"));
        let categories = JSON.parse(localStorage.getItem("categories"));

        if(activeItems === null){
            localStorage.setItem("activeItems", JSON.stringify([]));
        }

        if(savedItems === null){
            localStorage.setItem("savedItems", JSON.stringify([]));
        }

        if(categories === null){
            localStorage.setItem("categories", JSON.stringify(['All']));
        }

        renderActiveItems();
        renderSavedItems();
        renderCategories();
    }

    function renderActiveItems(){
        let activeItems = JSON.parse(localStorage.getItem("activeItems")) || [];
        let activeItemRows = [];

        let caloriesTotal = 0;
        let proteinTotal = 0;

        for(let activeItem of activeItems){
            let dateObj = new Date(activeItem.id); 
            let localTime = dateObj.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });

            activeItem.calories = Number(activeItem.calories || 0).toFixed(2);
            activeItem.protein = Number(activeItem.protein || 0).toFixed(2);

            activeItemRows.push( `
                <tr>
                    <td>${localTime}</td>
                    <td>${activeItem.item || 'Air'}</td>
                    <td>${activeItem.calories}</td>
                    <td>${activeItem.protein}</td>
                    <td>
                        <button onclick="cutItem(${activeItem.id}, 'activeItems')">âž–</button>
                    </td>
                </tr>
            `);

            caloriesTotal += Number(activeItem.calories);
            proteinTotal += Number(activeItem.protein);
        }

        document.getElementById("activeItems").innerHTML = `
            <tr>
                <th>Time</th>
                <th>Item</th>
                <th>Calories: ${caloriesTotal.toFixed(2)}</th>
                <th>Protein: ${proteinTotal.toFixed(2)}</th>
                <th>Cut</th>
            </tr>
            ${activeItemRows.join('')}
        `;
    }

    function renderSavedItems(){
        let savedItems = JSON.parse(localStorage.getItem("savedItems")) || [];
        let activeCategory = document.getElementById("categories").value || 'All';
        let savedItemRows = [];

        for(let savedItem of savedItems){
            if([savedItem.category, 'All'].includes(activeCategory)){
                savedItem.calories = Number(savedItem.calories || 0).toFixed(2);
                savedItem.protein = Number(savedItem.protein || 0).toFixed(2);
                savedItem.quantity = Number(savedItem.quantity || 1).toFixed(2);
                
                savedItemRows.push(`
                    <tr>
                        <td>
                            <button onclick="insertSavedItem(${savedItem.id})">âž•</button>
                        </td>
                        <td>${savedItem.item}</td>
                        <td>${savedItem.calories}</td>
                        <td>${savedItem.protein}</td>
                        <td>${savedItem.quantity}</td>
                        <td>
                            <button onclick="cutItem(${savedItem.id}, 'savedItems')">âž–</button>
                        </td>
                    </tr>
                `);
            }
        }

        document.getElementById("savedItems").innerHTML = 
            `<tr>
                <th>Add</th>
                <th>Item</th>
                <th>Calories</th>
                <th>Protein</th>
                <th>Qty.</th>
                <th>Cut</th>
            </tr>
            ${savedItemRows.join('')}
        `
    }

    function renderCategories(){
        let categories = JSON.parse(localStorage.getItem("categories")) || ['All'];
        document.getElementById("categories").innerHTML = categories.map(category => `<option value="${category}">${category}</option>`).join('');
    }

    function saveItem(){
        let id = Date.now();
        let item = document.getElementById("item").value.trim() || 'Air';
        let calories = Number(document.getElementById("calories").value || 0).toFixed(2);
        let protein = Number(document.getElementById("protein").value || 0).toFixed(2);
        let quantity = Number(document.getElementById("quantity").value || 1).toFixed(2);
        let category = document.getElementById("categories").value.trim();

        let savedItems = JSON.parse(localStorage.getItem("savedItems")) || [];
        savedItems.push({ id, item, calories, protein, quantity, category });
        localStorage.setItem("savedItems", JSON.stringify(savedItems));

        renderSavedItems();
    }

    function insertSavedItem(id){
        let savedItems = JSON.parse(localStorage.getItem("savedItems")) || [];
        let savedItem = savedItems.find(item => item.id === id);

        document.getElementById("item").value = savedItem.item || 'Air';
        document.getElementById("calories").value = savedItem.calories || 0;
        document.getElementById("protein").value = savedItem.protein || 0;
        document.getElementById("quantity").value = savedItem.quantity || 1;
    }

    function insertActiveItem(){
        let id = Date.now();
        let item = document.getElementById("item").value.trim() || "Air";
        let calories = Number(document.getElementById("calories").value || 0);
        let protein = Number(document.getElementById("protein").value || 0);
        let quantity = Number(document.getElementById("quantity").value || 1);

        calories = (calories * quantity).toFixed(2);
        protein = (protein * quantity).toFixed(2);

        let activeItems = JSON.parse(localStorage.getItem("activeItems")) || [];
        activeItems.push({id, item, calories, protein});
        localStorage.setItem("activeItems", JSON.stringify(activeItems));

        renderActiveItems();
    }

    function cutItem(id, location){
        if(confirm('Are you sure you want to remove this item?')){
            let targetItems = JSON.parse(localStorage.getItem(location)) || [];
            targetItems = targetItems.filter(item => item.id !== id);
            localStorage.setItem(location, JSON.stringify(targetItems));

            switch(location){
                case 'activeItems':
                    renderActiveItems();
                    break;
                case 'savedItems':
                    renderSavedItems();
                    break;
            }
        }
    }

    function resetDay(){
        if(confirm('Are you sure you want to reset the day?')){
            if(confirm('Super sure?!?')){
                localStorage.setItem("activeItems", JSON.stringify([]));

                renderActiveItems();
            }
        }
    }

    function addCategory(){
        let categories = JSON.parse(localStorage.getItem("categories")) || [];

        const newCategory = prompt("Add new category:");

        if(newCategory && newCategory.length > 0){
            if(!categories.includes(newCategory) && newCategory.toLowerCase() !== 'all'){
                categories.push(newCategory);
                localStorage.setItem("categories", JSON.stringify(categories));

                renderCategories();
            }
            else{
                alert('Category already exists')
            }
        }
        else{
            alert('Enter a valid category name');
        }
    }

    function removeCategory(){
        if(confirm('Are you sure you want to delete this category?')){
            let activeCategory = document.getElementById("categories").value;
            if(activeCategory.toLowerCase() !== 'all'){
                let categories = JSON.parse(localStorage.getItem("categories"));

                categories = categories.filter(savedCategory => savedCategory !== activeCategory);
                localStorage.setItem("categories", JSON.stringify(categories));

                renderCategories();
                renderSavedItems();
            };
        };
    }

    init();
</script>